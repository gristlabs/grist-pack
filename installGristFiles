#!/bin/bash

# Define the paths to the files
script_dir=$(dirname "$0")
localfile_path="$script_dir/rc.local"
restartgrist_path="$script_dir/restartGrist"
gristparameters_path="$script_dir/gristParameters"
dexyaml_path="$script_dir/dex.yaml"

instalation_path="$HOME/grist"

# Check if the files exist
for file_path in "$localfile_path" "$restartgrist_path" "$gristparameters_path" "$dexyaml_path"; do
    if [ ! -f "$file_path" ]; then
        echo "File not found: $file_path"
        exit 1
    fi
done

# Add execute permissions to the files
for file_path in "$localfile_path" "$restartgrist_path" "$gristparameters_path"; do
    chmod +x "$file_path"
    if [ $? -ne 0 ]; then
        echo "Failed to change permissions for: $file_path"
        exit 1
    fi
done

# Check if ~/grist exists and create it if it doesn't
if [ ! -d $instalation_path ]; then
    mkdir $instalation_path
fi

# Initialize flags
rc=0
r=0
p=0
d=0

# Parse command-line options
while getopts "f:arpdrc" opt; do
    case $opt in
        f)
            force=1
            IFS=' ' read -ra ADDR <<< "$OPTARG"
            for i in "${ADDR[@]}"; do
                case "$i" in
                    a)
                        rc=1
                        r=1
                        p=1
                        d=1
                        ;;
                    r)
                        r=1
                        ;;
                    p)
                        p=1
                        ;;
                    d)
                        d=1
                        ;;
                    rc)
                        rc=1
                        ;;
                esac
            done
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1
            ;;
    esac
done

# If no flags were set, set all flags to 1
if [ $force -eq 0 ]; then
    rc=1
    r=1
    p=1
    d=1
fi

# Move the files to their destinations
if [ -f "/etc/$(basename $localfile_path)" ] && [ $rc -eq 1 ]; then
    mv -f "$localfile_path" /etc
    echo "Moved: $localfile_path"
elif [ -f "/etc/$(basename $localfile_path)" ]; then
    echo "File already exists and was not moved: $localfile_path"
fi

if [  -f "$instalation_path/$(basename $restartgrist_path)" ] && [ $r -eq 1 ]; then
    mv -f "$restartgrist_path" $instalation_path
    echo "Moved: $restartgrist_path"
elif [ -f "$instalation_path/$(basename $restartgrist_path)" ]; then
    echo "File already exists and was not moved: $restartgrist_path"
fi

if [  -f "$instalation_path/$(basename $gristparameters_path)" ] && [ $p -eq 1 ]; then
    mv -f "$gristparameters_path" $instalation_path
    echo "Moved: $gristparameters_path"
elif [ -f "$instalation_path/$(basename $gristparameters_path)" ]; then
    echo "File already exists and was not moved: $gristparameters_path"
fi

if [  -f "$instalation_path/$(basename $dexyaml_path)" ] && [ $d -eq 1 ]; then
    mv -f "$dexyaml_path" $instalation_path
    echo "Moved: $dexyaml_path"
elif [ -f "$instalation_path/$(basename $dexyaml_path)" ]; then
    echo "File already exists and was not moved: $dexyaml_path"
fi